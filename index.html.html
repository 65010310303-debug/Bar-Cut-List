<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEC Bar-Cut List | Professional Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        
        /* Rebar Texture (ลายเหล็กข้ออ้อย) */
        .rebar-texture {
            background-image: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.2) 5px,
                transparent 5px,
                transparent 10px
            );
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Print Settings */
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .page-break { page-break-before: always; }
            .print-container { margin: 0; width: 100%; max-width: none; box-shadow: none; border: none; }
            /* บังคับพิมพ์พื้นหลังสี */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        /* Input Focus Effect */
        input:focus, select:focus {
            outline: 2px solid #24306e;
            outline-offset: 1px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white shadow-md border-b-4 border-[#24306e] sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center font-serif font-bold text-3xl tracking-widest border-2 border-slate-200 px-3 py-1 rounded">
                    <span style="color:#24306e">M</span>
                    <span style="color:#e21c23">E</span>
                    <span style="color:#24306e">C</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 leading-tight">Bar-Cut List <span class="text-xs bg-red-600 text-white px-1 rounded ml-1 align-top">PRO</span></h1>
                    <p class="text-xs text-slate-500">Rebar Optimization Tool by Somoil</p>
                </div>
            </div>
            <div>
                <button onclick="window.print()" class="bg-[#24306e] text-white px-4 py-2 rounded shadow hover:bg-slate-800 transition flex items-center gap-2">
                    <i class="fa-solid fa-print"></i> <span class="hidden sm:inline">พิมพ์รายงาน</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-4 sm:p-6 space-y-6 print-container">
        
        <div class="bg-white rounded-xl shadow p-6 border border-slate-200 no-print">
            <div class="flex items-center gap-2 mb-6 border-b pb-2">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-[#24306e]"><i class="fa-solid fa-plus"></i></div>
                <h2 class="text-lg font-bold text-slate-700">เพิ่มรายการตัดเหล็ก</h2>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-12 gap-4 mb-6">
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">ประเภท</label>
                    <select id="steel-type" class="w-full border border-slate-300 rounded p-2 bg-slate-50">
                        <option value="DB">DB (ข้ออ้อย)</option>
                        <option value="RB">RB (เหล็กกลม)</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">ขนาด</label>
                    <select id="diameter" class="w-full border border-slate-300 rounded p-2 bg-slate-50">
                        <option value="" selected disabled>เลือกขนาด</option>
                        <option value="6">6 mm</option>
                        <option value="9">9 mm</option>
                        <option value="12">12 mm</option>
                        <option value="16">16 mm</option>
                        <option value="20">20 mm</option>
                        <option value="25">25 mm</option>
                        <option value="28">28 mm</option>
                        <option value="32">32 mm</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">ความยาวเต็ม (ม.)</label>
                    <input type="number" id="cut-length" value="10" class="w-full border border-slate-300 rounded p-2">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-xs font-bold text-blue-600 mb-1">ที่ต้องการ (ม.)</label>
                    <input type="number" id="required-length" placeholder="0.00" class="w-full border-2 border-blue-200 rounded p-2 bg-blue-50 font-bold text-slate-800">
                </div>
                <div class="col-span-1 md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 mb-1">จำนวน</label>
                    <input type="number" id="quantity" value="1" min="1" class="w-full border border-slate-300 rounded p-2 text-center">
                </div>
                <div class="col-span-2 md:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Note / ตำแหน่ง</label>
                    <input type="text" id="notes" placeholder="เช่น เสา C1" class="w-full border border-slate-300 rounded p-2">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="addItem()" class="flex-1 bg-[#24306e] text-white py-3 rounded shadow hover:bg-slate-800 transition font-bold">
                    <i class="fa-solid fa-circle-plus"></i> เพิ่มรายการ
                </button>
                <button onclick="calculate()" id="calc-btn" disabled class="flex-1 bg-emerald-500 text-white py-3 rounded shadow hover:bg-emerald-600 transition font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-calculator"></i> คำนวณ
                </button>
                <button onclick="resetForm()" class="px-6 bg-slate-200 text-slate-600 rounded hover:bg-slate-300 font-bold">
                    รีเซ็ต
                </button>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-100">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-slate-500">รายการรอคำนวณ (<span id="temp-count" class="text-blue-600">0</span>)</h3>
                    <button onclick="clearAll()" class="text-xs text-red-500 hover:underline">ลบทั้งหมด</button>
                </div>
                <div id="temp-list" class="bg-slate-50 rounded border border-dashed border-slate-300 p-4 min-h-[80px] text-center text-slate-400 text-sm">
                    ยังไม่มีรายการ... กรุณาเพิ่มข้อมูลด้านบน
                </div>
            </div>
        </div>

        <div id="report-area" class="hidden space-y-6">
            
            <div class="bg-white rounded-xl shadow p-6 border border-slate-200">
                <div class="flex justify-between items-end border-b-2 border-emerald-500 pb-4 mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Bill of Materials</h2>
                        <p class="text-sm text-slate-500">ใบสรุปรายการสั่งซื้อเหล็ก</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-[#24306e]">MEC</div>
                        <div class="text-xs text-slate-400">Date: <span id="print-date"></span></div>
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-emerald-50 text-emerald-900">
                        <tr>
                            <th class="p-3 text-left">รายการ (Item)</th>
                            <th class="p-3 text-center">ความยาวมาตรฐาน (ม.)</th>
                            <th class="p-3 text-center">จำนวนที่ต้องสั่ง (เส้น)</th>
                            <th class="p-3 text-right">น้ำหนักรวม (กก.)</th>
                        </tr>
                    </thead>
                    <tbody id="po-table-body" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>

            <div id="cutting-plan-container" class="space-y-4">
                </div>

            <div class="bg-white rounded-xl shadow p-6 border border-slate-200 page-break">
                <div class="flex items-center gap-2 mb-4 border-b pb-2">
                    <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i class="fa-solid fa-trash-can"></i></div>
                    <h2 class="text-lg font-bold text-slate-700">สรุปเศษเหล็ก (Waste Report)</h2>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-2 text-left">Type</th>
                            <th class="p-2 text-center">ID</th>
                            <th class="p-2 text-center">เศษเหลือ (ม.)</th>
                            <th class="p-2 text-left">Note</th>
                        </tr>
                    </thead>
                    <tbody id="waste-table-body" class="divide-y divide-slate-100 text-slate-600">
                        </tbody>
                </table>
            </div>

            <div class="text-center text-slate-400 text-xs py-8">
                Report generated by MEC Bar-Cut List | Developed by Somoil
            </div>
        </div>
    </main>

    <script>
        // --- Variables ---
        let items = [];
        const steelWeights = { '6': 0.222, '9': 0.499, '12': 0.888, '16': 1.58, '20': 2.47, '25': 3.85, '28': 4.83, '32': 6.31 };
        
        // --- Functions ---
        
        function formatNum(num) {
            return parseFloat(num).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function showAlert(msg, isError = false) {
            // Simple alert fallback
            alert(msg); 
        }

        // Add Item Logic
        function addItem() {
            try {
                const type = document.getElementById('steel-type').value;
                const dia = document.getElementById('diameter').value;
                const cutLen = parseFloat(document.getElementById('cut-length').value);
                const reqLen = parseFloat(document.getElementById('required-length').value);
                const qty = parseInt(document.getElementById('quantity').value);
                const note = document.getElementById('notes').value || '-';

                // Validation
                if (!dia) { alert('กรุณาเลือกขนาดเหล็ก'); return; }
                if (!reqLen || reqLen <= 0) { alert('กรุณาระบุความยาวที่ต้องการ'); return; }
                if (!cutLen || cutLen <= 0) { alert('กรุณาระบุความยาวเต็มเส้น'); return; }
                if (reqLen > cutLen) { alert('ความยาวที่ต้องการ ยาวกว่าเหล็กเต็มเส้น!'); return; }
                if (!qty || qty < 1) { alert('จำนวนต้องมากกว่า 0'); return; }

                // Add to array
                items.push({
                    id: Date.now(),
                    type, dia, cutLen, reqLen, qty, note
                });

                // Clear input
                document.getElementById('required-length').value = '';
                document.getElementById('notes').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('required-length').focus();

                renderTempList();

            } catch (err) {
                console.error(err);
                alert("เกิดข้อผิดพลาด: " + err.message);
            }
        }

        // Render List
        function renderTempList() {
            const listEl = document.getElementById('temp-list');
            const countEl = document.getElementById('temp-count');
            const calcBtn = document.getElementById('calc-btn');

            countEl.innerText = items.length;
            calcBtn.disabled = items.length === 0;

            if (items.length === 0) {
                listEl.innerHTML = 'ยังไม่มีรายการ... กรุณาเพิ่มข้อมูลด้านบน';
                return;
            }

            let html = '<div class="space-y-2">';
            items.forEach((item, index) => {
                html += `
                    <div class="bg-white border border-slate-200 p-2 rounded flex justify-between items-center shadow-sm">
                        <div class="flex gap-3 items-center text-left">
                            <div class="bg-slate-100 px-2 py-1 rounded font-bold text-slate-700 text-sm w-16 text-center">
                                ${item.type}${item.dia}
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-800">
                                    ตัด <span class="text-blue-600">${formatNum(item.reqLen)}</span> ม. 
                                    <span class="text-slate-400">x</span> ${item.qty} เส้น
                                </div>
                                <div class="text-xs text-slate-500">
                                    จาก ${formatNum(item.cutLen)} ม. | ${item.note}
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteItem(${index})" class="text-slate-300 hover:text-red-500 px-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            listEl.innerHTML = html;
        }

        function deleteItem(index) {
            items.splice(index, 1);
            renderTempList();
        }

        function clearAll() {
            if(confirm('ยืนยันลบข้อมูลทั้งหมด?')) {
                items = [];
                renderTempList();
                document.getElementById('report-area').classList.add('hidden');
            }
        }

        function resetForm() {
            document.getElementById('required-length').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('quantity').value = '1';
        }

        // --- Calculation Core ---
        function calculate() {
            if (items.length === 0) return;

            // 1. Group items by Type & Diameter
            const grouped = {};
            items.forEach(item => {
                const key = `${item.type}|${item.dia}|${item.cutLen}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(item);
            });

            let poHtml = '';
            let cuttingHtml = '';
            let wasteHtml = '';

            // Process each group
            Object.keys(grouped).forEach(key => {
                const [type, dia, stdLenStr] = key.split('|');
                const stdLen = parseFloat(stdLenStr);
                const groupItems = grouped[key];

                // Create pieces array
                let pieces = [];
                groupItems.forEach(i => {
                    for (let n = 0; n < i.qty; n++) {
                        pieces.push({ len: i.reqLen, note: i.note });
                    }
                });
                // Sort Descending (Best Fit / First Fit Descending Strategy)
                pieces.sort((a, b) => b.len - a.len);

                // Cutting Optimization
                let bars = [];
                pieces.forEach(piece => {
                    let placed = false;
                    for (let bar of bars) {
                        if (bar.used + piece.len <= stdLen) {
                            bar.parts.push(piece);
                            bar.used += piece.len;
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        bars.push({
                            parts: [piece],
                            used: piece.len,
                            waste: stdLen - piece.len
                        });
                    }
                });

                // Generate HTML for PO
                const totalBars = bars.length;
                const unitWeight = steelWeights[dia] || 0;
                const totalWeight = totalBars * stdLen * unitWeight;
                
                poHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3 font-bold text-slate-700">${type} - ${dia} mm</td>
                        <td class="p-3 text-center">${formatNum(stdLen)}</td>
                        <td class="p-3 text-center font-bold text-blue-600 bg-blue-50">${totalBars}</td>
                        <td class="p-3 text-right font-mono">${formatNum(totalWeight)}</td>
                    </tr>
                `;

                // Generate HTML for Cutting Plan
                cuttingHtml += `<div class="bg-white rounded-xl shadow border border-slate-200 p-4 mb-4 break-inside-avoid">`;
                cuttingHtml += `<div class="border-b pb-2 mb-2 flex justify-between font-bold text-slate-700"><span>${type}-${dia}mm (Full: ${stdLen}m)</span> <span>Total: ${totalBars} Bars</span></div>`;
                
                bars.forEach((bar, idx) => {
                    // Waste Data
                    const noteStr = [...new Set(bar.parts.map(p => p.note))].join(', ');
                    wasteHtml += `
                        <tr class="hover:bg-slate-50 border-b border-slate-100">
                            <td class="p-2">${type}${dia}</td>
                            <td class="p-2 text-center text-slate-400">#${idx+1}</td>
                            <td class="p-2 text-center font-bold text-red-500">${formatNum(bar.waste)}</td>
                            <td class="p-2 text-xs text-slate-500 truncate max-w-[150px]">${noteStr}</td>
                        </tr>
                    `;

                    // Visual Bar
                    cuttingHtml += `<div class="mb-2 text-xs">`;
                    cuttingHtml += `<div class="flex justify-between mb-1 text-slate-500"><span>Bar #${idx+1}</span> <span>Waste: ${formatNum(bar.waste)}m</span></div>`;
                    cuttingHtml += `<div class="flex w-full h-6 bg-slate-200 rounded overflow-hidden border border-slate-300">`;
                    
                    bar.parts.forEach((p, pid) => {
                        const width = (p.len / stdLen) * 100;
                        const bgColors = ['bg-slate-600', 'bg-slate-500', 'bg-slate-700', 'bg-slate-800'];
                        const color = bgColors[pid % bgColors.length];
                        cuttingHtml += `
                            <div style="width:${width}%" class="${color} rebar-texture text-white flex items-center justify-center border-r border-white/20 whitespace-nowrap overflow-hidden px-1" title="${p.len}m (${p.note})">
                                ${p.len}
                            </div>
                        `;
                    });
                    
                    cuttingHtml += `</div></div>`;
                });
                cuttingHtml += `</div>`;
            });

            // Update DOM
            document.getElementById('po-table-body').innerHTML = poHtml;
            document.getElementById('cutting-plan-container').innerHTML = cuttingHtml;
            document.getElementById('waste-table-body').innerHTML = wasteHtml;
            document.getElementById('print-date').innerText = new Date().toLocaleDateString('th-TH');

            // Show Result
            document.getElementById('report-area').classList.remove('hidden');
            
            // Auto Scroll to result
            document.getElementById('report-area').scrollIntoView({ behavior: 'smooth' });
        }

        // --- Init ---
        // Enter Key Support
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && document.activeElement.tagName === 'INPUT') {
                addItem();
            }
        });

    </script>
</body>
</html>